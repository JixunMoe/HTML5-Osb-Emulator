/*
 * osb Emulator
 *   Written by Jixun with jQuery and Kenetic JS framework.
 *   http://jixun.org/
 *   Released under GNU license (Don't really understands it though.
 */

function playOsu(g,z){function E(c){c=new Audio(g.basePath+c);$(document.body).append(c);c.preload="";c.controls=!0;$(c).css({bottom:0,position:"fixed",left:0});return c}function F(){function f(){c.upd=B(f);c.mainAudio.paused||(e.draw(),c.timeLayer.labelTime2.setText((c.time=c.mainAudio.currentTime).toFixed(3)),b.forEach(function(b){c.osbLayers[b].forEach(function(b){setTimeout(function(){b.commands.forEach(function(c){(c||function(){})(b.dM())})},0)})}))}c.fInit.forEach(function(b){b()});var b=[0,2,3];b.forEach(function(b){e.add(c.osbLayersK[b]);c.osbLayers[b].forEach(function(b){setTimeout(function(){b.commands.forEach(function(c){(c||function(){})(b.finalize())})},0)})});c.loadingMsg.layer.hide();c.timeLayer.layer.show().moveToTop();$(c.mainAudio).on("ended",function(){window.stt=e;G(c.upd);$(this).fadeOut(1E3,function(){$(this).remove()})});c.mainAudio.play();c.upd=B(f)}function H(c,b,e,n,q){function k(){++d>s?b(a):$.ajax({url:c[d],cache:!0,timeout:q,success:function(b){setTimeout(function(){e(d)},0);a.push(b);k()},error:n})}var d=-1,s=c.length-1,a=[];k()}function I(f){var b=new Kinetic.Group;b.hide();c.osbLayersK[f.layer].add(b);var e=f.ani,n=f.aniConf,q=-1,k={show:y,hide:y},d=n.frameDelay/1E3/(g.animationSpeed||1),s,a=0,h=0;e&&(n.bLoopForever||(s=d*n.frameCount));var h=-1,m=e?function(){var a=c.time-h;if(n.bLoopForever||!(a>s))if(a=Math.floor(a/d)%n.frameCount,a!=q){var f=b.children;(f[q]||k).hide();q=a;(f[q]||k).show()}}:y,e=c.osbLayers[f.layer].push({layer:b,commands:[],origin:f.origin,xyOffset:{},path:f.path,x:f.x,y:f.y,isAni:e,aniConf:n,fRender:function(){},hi:function(b){a<b&&(a=b)},lo:function(a){if(-1==h||h>a)h=a},dM:function(){var d=c.time>h&&a>c.time;d?(m(),b.getVisible()||b.show()):b.hide();return d},finalize:function(){}})-1;c.osbLayers[f.layer][e].image=f.image(b,f.origin);return{i:e,layer:b}}function A(f){f?c.iF++:c.iC++;c.loadingMsg.text.setText("Loading image: "+c.iF+"/"+c.iC+"...");e.draw();c.iF==c.iC&&(c.loadingMsg.anim.stop(),F())}function J(){function f(){if(++k>=d)return 0;m=r[k].replace(/(^[\s_]+|[\s_]+$)/g,"");if(/(^\s*\/\/|\[|^\s*$)/.test(m))return f();h=(r[k].match(/^\s+/g)||[""])[0].length;return[h,m]}var b=c.osuData.match(/\[Events\]\n([\s\S]+?)\n\[/m);b&&(c.osbData=b[1]+"\n"+c.osbData);c.osbData=c.osbData.replace(/^(\d+,\d+),(".+?")(|,\d+,\d+)$/gm,"Sprite,Background,FillScreen,$2,$1\n S,0,0,999999,1\n");for(var r=c.osbData.replace(/,\s+/g,",").replace(/,,/g,",0,").split("\n"),b=["Background","Fail","Pass","Foreground"],n="TopLeft TopCentre TopRight CentreLeft Centre CentreRight BottomLeft BottomCentre BottomRight FillScreen".split(" "),q=0,k=-1,d=r.length,s,a=!1,h,m,v=-1;0!==f();)if(a=m.match(/(Sprite|Animation),(Background|Fail|Pass|Foreground),(TopLeft|TopCentre|TopRight|CentreLeft|Centre|CentreRight|BottomLeft|BottomCentre|BottomRight|FillScreen),"(.+?)",([\d-]+),([\d-]+)($|,([\d-]+),([\d-]+),(LoopForever|LoopOnce))/)){var p="Animation"==a[1],t={frameCount:Number(a[8]),frameDelay:Number(a[9]),bLoopForever:"LoopForever"==a[10]},q=b.indexOf(a[2]),u=I({layer:q,origin:a[3],path:a[4],x:Number(a[5]),y:Number(a[6]),ani:p,aniConf:t,image:function(){var b=a,c=p;return function(d,f){var p=[],e="",h=n.indexOf(f),k=9==h,l=t;k&&(h=0);(function(a){function f(){A(0);var a=new Image;a.onload=function(){e=!0;var f=h%3/2*this.width,p=(h-h%3)/6*this.height,l=new Kinetic.Image({image:a});d.setOffset(f,p);d.noPosfix||(d.noPosfix=!0,d.setPosition(Number(b[5]),Number(b[6])));d.add(l);c&&l.hide();k&&l.setScale(480/this.height);A(1)};a.onerror=function(){console.warn("Img load failed: ",this.src);A(2)};return a}if(c){var m=g.basePath+a.substr(0,a.length-4);a=a.substr(-4);for(var q=0;q<l.frameCount;q++){var t=f();t.src=(m+q+a).replace(/\\/g,"/");p.push(t)}}else t=f(),t.src=(g.basePath+a).replace(/\\/g,"/"),p.push(t)})(a[4]);return{kImage:function(){return p},loaded:function(){return e}}}}()}),v=u.i;s=u.layer}else 0>v||0>=h?console.error("Invalid or unsupported statement:",m):function(){for(var a=[{l:m,s:h}],b=0,d="",p=k,e=[{s:1,c:0}];;){d=f();if(0==d)break;if(0==d[0])break;d[0]!=a[b].s?e.push({s:d[0],c:1}):e[e.length-1].c++;b=a.push({l:d[1],s:d[0]})-1;p=k}e.shift();var t=[];e.forEach(function(a){1!=a.s&&t.push(a)});e=t;k=p;for(var n=d=b=0,p=-1,u=[],l,g,r=c.osbLayers[q][v],x=-1;!(++x>=a.length);)if(u=a[x],g=u.l.match(/^L,([\d-]*),([\d-]*)/))b=parseInt(g[1]),d=parseInt(g[2]);else if(1<u.s){g=0;p++;for(var u=[],w=0;w<e[p].c;w++)l=u[u.push(C(a[x+w].l))-1],l=l[3]||l[2],l>g&&(g=l);for(w=0;w<e[p].c;w++)for(n=b,l=u[w].slice(0),l[3]=l[3]||l[2],l[2]+=n,l[3]+=n,n=0;n<d;n++)r.commands.push(D(!1,s,r,!1,l)),l[2]+=g,l[3]+=g;x+=e[p].c-1}else r.commands.push(D(u.l,s,r,!1))}();c.loadingMsg.text.setText("Parse finish! For details please review console log.\nNow downloading resources...");e.draw()}var B=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(c,b){return window.setTimeout(c,1E3/120)}}(),G=window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout,y=function(){};"string"==typeof z&&$(document.getElementById(z));var e=new Kinetic.Stage({container:z,width:640,height:480});if(e){var c={stage:e,loadingMsg:{anim:0,layer:new Kinetic.Layer,circle:new Kinetic.Circle({x:e.getWidth()/4,y:e.getHeight()/2,radius:20,fill:"pink",opacity:0.7}),circleRotate:new Kinetic.Circle({x:e.getWidth()/4,y:e.getHeight()/2,radius:23,fillLinearGradientStartPoint:[0,0],fillLinearGradientEndPoint:[60,0],fillLinearGradientColorStops:[0,"pink",1,"red"],opacity:0.9}),text:new Kinetic.Text({text:"Loading...",x:e.getWidth()/4+30,y:e.getHeight()/2,fill:"black"})},timeLayer:{layer:new Kinetic.Layer,labelTime1:new Kinetic.Text({text:"Time:",x:10,y:5,fill:"black",shadowColor:"white",shadowBlur:3,shadowOffset:0.5,shadowOpacity:0.7}),labelTime2:new Kinetic.Text({text:"-",x:50,y:5,fill:"#555",shadowColor:"white",shadowBlur:3,shadowOffset:0.5,shadowOpacity:0.7})},osuData:0,osbData:0,osbLayersK:[new Kinetic.Layer,new Kinetic.Layer,new Kinetic.Layer,new Kinetic.Layer],osbLayers:[[],[],[],[]],mainAudio:E(g.musicPath),upd:0,time:0,iC:0,iF:0,fInit:[]};c.loadingMsg.layer.add(c.loadingMsg.circleRotate);c.loadingMsg.layer.add(c.loadingMsg.circle);c.loadingMsg.layer.add(c.loadingMsg.text);e.add(c.loadingMsg.layer);c.loadingMsg.anim=new Kinetic.Animation(function(f){c.loadingMsg.circleRotate.rotate(f.timeDiff*Math.PI/1E3)},c.loadingMsg.layer);c.loadingMsg.anim.start();c.timeLayer.layer.hide();c.timeLayer.layer.add(c.timeLayer.labelTime1);c.timeLayer.layer.add(c.timeLayer.labelTime2);e.add(c.timeLayer.layer);e.draw();var C=function(c){c=c.replace(/\s/g,"").split(",");for(var b=0;b<c.length;b++)c[b]=""==c[b]||"0"==c[b]?0:parseFloat(c[b])||c[b].toUpperCase();return c},D=function(f,b,e,n,g){var k=f||g.join(","),d={},s=f?(k.match(/^([A-Z]+),/)||[,!1])[1]:g[0],a;a=f?C(k):g.slice(0);a.shift();a[1]=Number(a[1])/1E3;a[2]=Number(a[2])/1E3;d.timeRange=0==a[2]?1:a[2]-a[1]||1;d.finalTime=(a[2]||a[1])+3;d.finalized=!1;f=[function(){return(c.time-a[1])/d.timeRange},function(){var b=(c.time-a[1])/d.timeRange;return Math.sqrt(b+b-b*b)},function(){var b=(c.time-a[1])/d.timeRange;return 1-Math.sqrt(1-b*b)}];var h=f[a[0]]||f[0];if(!s)return console.error("Unable to match command, is it invalid?  =>",k),y;switch(s){case "T":console.error("Unsupported command :(",k);break;default:var m={F:{cb:function(c,e,f,g,k){b.setOpacity(d.opaRange*h()+a[3])},init:function(){5>a.length&&(a[4]=a[3]);d.opaRange=a[4]-a[3];b.firstOpa||(b.firstOpa=!0,b.setOpacity(a[3]))},finalize:function(){b.setOpacity(a[4])}},M:{cb:function(c,e,f,g,k,m,n){b.setPosition(d.xRange*h()+a[3],d.yRange*h()+a[4])},init:function(){6>a.length&&(a[5]=a[3],a[6]=a[4]);d.xRange=a[5]-a[3];d.yRange=a[6]-a[4];b.noPosfix||(b.noPosfix=!0,b.setPosition(a[3],a[4]))},finalize:function(){b.setPosition(a[5],a[6])}},MX:{cb:function(c,e,f,g,k){b.setX(d.xRange*h()+a[3])},init:function(){5>a.length&&(a[4]=a[3]);d.xRange=a[4]-a[3];b.noPosfix||(b.noPosfix=!0,b.setX(a[3]))},finalize:function(){b.setX(a[4])}},MY:{cb:function(c,e,f,g,k){b.setY(d.yRange*h()+a[3])},init:function(){5>a.length&&(a[4]=a[3]);d.yRange=a[4]-a[3];b.noPosfix||(b.noPosfix=!0,b.setY(a[3]))},finalize:function(){b.setY(a[4])}},S:{cb:function(c,e,f,g,k){b.setScale(d.sRange*h()+a[3])},init:function(){5>a.length&&(a[4]=a[3]);d.sRange=a[4]-a[3];b.firstScale||(b.firstScale=!0,b.setScale(a[3]))},finalize:function(){b.setScale(a[4])}},V:{cb:function(c,e,f,g,k,m,n){b.setScale(d.xsRange*h()+a[3],d.ysRange*h()+a[4])},init:function(){6>a.length&&(a[5]=a[3],a[6]=a[4]);d.xsRange=a[5]-a[3];d.ysRange=a[6]-a[4];b.firstScale||(b.firstScale=!0,b.setScale(a[3],a[4]))},finalize:function(){b.setScale(a[5],a[6])}},R:{cb:function(c,e,f,g,k){b.setRotation(d.rRange*h()+a[3])},init:function(){5>a.length&&(a[4]=a[3]);d.rRange=a[4]-a[3];b.firstRotate||(b.firstRotate=!0,b.setRotation(a[3]))},finalize:function(){b.setRotation(a[4])}},P:{cb:function(a,b,c,e){d.flip||(d.flip=!0,d.fl())},init:function(){d.fM="HVA".indexOf(a[3].substr(0,1));d.fN=["X","Y"][d.fM];d.fW=["Width","Height"][d.fM];d.fV=-1;d.fl=function(){b.children.forEach(function(a){var b=-1*a["getScale"+d.fN]();a["setOffset"+d.fN](-1==b?a["get"+d.fW]():0);a["setScale"+d.fN](b)})};d.fl()},finalize:function(){a[2]&&d.fl()}},C:{cb:function(c,e,f,g,k,m,n,q,s){if(0!=b.cD%3)return b.cD=++b.cD%3;var r=[parseInt(d.rRange*h()+a[3])||255,parseInt(d.gRange*h()+a[4])||255,parseInt(d.bRange*h()+a[5])||255];if(!(r<b.colourConf||b.colourConf<r))return console.log("Colour frame dropped.");b.colourConf=r;b.children.forEach(function(a){a.setFilterColorizeColor(r);a.setFilter(Kinetic.Filters.Colorize)})},init:function(){7>a.length&&(a[6]=a[3],a[7]=a[4],a[8]=a[5]);b.cD||(b.cD=0);d.rRange=a[6]-a[3];d.gRange=a[7]-a[4];d.bRange=a[8]-a[5];b.colourConf||(b.colourConf=[a[3],a[4],a[5]],b.children.forEach(function(a){a.setFilterColorizeColor(b.colourConf);a.setFilter(Kinetic.Filters.Colorize)}))},finalize:function(){b.children.forEach(function(b){b.setFilterColorizeColor([a[6],a[7],a[8]]);b.setFilter(Kinetic.Filters.Colorize)})}}}[s],v;m&&m.init&&(c.fInit.push(m.init),v=m.finalize,m=m.cb)}m?n||(e.hi(a[2]||a[1]),e.lo(a[1])):(console.error("Invalid or unsupported command:",k),m=v=function(){});return function(b){b&&a[1]<=c.time&&a[2]>=c.time?(d.finalized=!1,m.call(this,a)):!d.finalized&&a[1]<=c.time&&(d.finalized=!0,v())}};H([g.basePath+g.osuPath,g.basePath+g.osbPath],function(f){c.loadingMsg.text.setText("Download success! Parsing file...");e.draw();c.osuData=f[0].replace(/\r/g,"");c.osbData=f[1].replace(/\r/g,"");setTimeout(J,0)},function(){},function(){c.loadingMsg.text.setText("Error while loading resource:"+JSON.stringify(arguments));e.draw()},1E4);return c}console.error("Unable to create stage.")};